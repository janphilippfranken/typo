/scr/jphilipp/miniconda3/envs/typo/lib/python3.10/site-packages/hydra/_internal/defaults_list.py:251: UserWarning: In 'train_typo_llama': Defaults list is missing `_self_`. See https://hydra.cc/docs/1.2/upgrades/1.0_to_1.1/default_composition_order for more information
  warnings.warn(msg, UserWarning)
Loading checkpoint shards:   0%|          | 0/30 [00:00<?, ?it/s]Loading checkpoint shards:   3%|â–Ž         | 1/30 [00:00<00:14,  1.96it/s]Loading checkpoint shards:   7%|â–‹         | 2/30 [00:00<00:11,  2.36it/s]Loading checkpoint shards:  10%|â–ˆ         | 3/30 [00:01<00:10,  2.47it/s]Loading checkpoint shards:  13%|â–ˆâ–Ž        | 4/30 [00:01<00:10,  2.57it/s]Loading checkpoint shards:  17%|â–ˆâ–‹        | 5/30 [00:01<00:09,  2.65it/s]Loading checkpoint shards:  20%|â–ˆâ–ˆ        | 6/30 [00:02<00:08,  2.71it/s]Loading checkpoint shards:  23%|â–ˆâ–ˆâ–Ž       | 7/30 [00:02<00:08,  2.69it/s]Loading checkpoint shards:  27%|â–ˆâ–ˆâ–‹       | 8/30 [00:03<00:08,  2.73it/s]Loading checkpoint shards:  30%|â–ˆâ–ˆâ–ˆ       | 9/30 [00:03<00:07,  2.74it/s]Loading checkpoint shards:  33%|â–ˆâ–ˆâ–ˆâ–Ž      | 10/30 [00:03<00:07,  2.85it/s]Loading checkpoint shards:  37%|â–ˆâ–ˆâ–ˆâ–‹      | 11/30 [00:04<00:06,  2.78it/s]Loading checkpoint shards:  40%|â–ˆâ–ˆâ–ˆâ–ˆ      | 12/30 [00:04<00:06,  2.87it/s]Loading checkpoint shards:  43%|â–ˆâ–ˆâ–ˆâ–ˆâ–Ž     | 13/30 [00:04<00:05,  2.85it/s]Loading checkpoint shards:  47%|â–ˆâ–ˆâ–ˆâ–ˆâ–‹     | 14/30 [00:05<00:05,  2.91it/s]Loading checkpoint shards:  50%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     | 15/30 [00:05<00:05,  2.76it/s]Loading checkpoint shards:  53%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž    | 16/30 [00:05<00:04,  2.83it/s]Loading checkpoint shards:  57%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹    | 17/30 [00:06<00:04,  2.94it/s]Loading checkpoint shards:  60%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    | 18/30 [00:06<00:04,  2.95it/s]Loading checkpoint shards:  63%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž   | 19/30 [00:06<00:03,  2.89it/s]Loading checkpoint shards:  67%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹   | 20/30 [00:07<00:03,  2.95it/s]Loading checkpoint shards:  70%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   | 21/30 [00:07<00:03,  2.98it/s]Loading checkpoint shards:  73%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž  | 22/30 [00:07<00:02,  3.07it/s]Loading checkpoint shards:  77%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹  | 23/30 [00:08<00:02,  3.09it/s]Loading checkpoint shards:  80%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  | 24/30 [00:08<00:01,  3.09it/s]Loading checkpoint shards:  83%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž | 25/30 [00:08<00:01,  3.17it/s]Loading checkpoint shards:  87%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹ | 26/30 [00:09<00:01,  3.22it/s]Loading checkpoint shards:  90%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ | 27/30 [00:09<00:00,  3.26it/s]Loading checkpoint shards:  93%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Ž| 28/30 [00:09<00:00,  3.24it/s]Loading checkpoint shards:  97%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹| 29/30 [00:09<00:00,  3.23it/s]Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 30/30 [00:10<00:00,  3.70it/s]Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 30/30 [00:10<00:00,  2.95it/s]
Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.
Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.
Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.
wandb: Currently logged in as: janphilipp-franken. Use `wandb login --relogin` to force relogin
wandb: wandb version 0.16.6 is available!  To upgrade, please run:
wandb:  $ pip install wandb --upgrade
wandb: Tracking run with wandb version 0.16.4
wandb: Run data is saved locally in /sailhome/jphilipp/research_projects/typo/experiments/scale/wandb/run-20240507_082603-20a753q9
wandb: Run `wandb offline` to turn off syncing.
wandb: Syncing run typo-lr-1e-6-iteration-1
wandb: â­ï¸ View project at https://wandb.ai/janphilipp-franken/typo-summarization-llama-70-diverse
wandb: ðŸš€ View run at https://wandb.ai/janphilipp-franken/typo-summarization-llama-70-diverse/runs/20a753q9
Special tokens have been added in the vocabulary, make sure the associated word embeddings are fine-tuned or trained.
Token indices sequence length is longer than the specified maximum sequence length for this model (2487 > 2048). Running this sequence through the model will result in indexing errors
Token indices sequence length is longer than the specified maximum sequence length for this model (2487 > 2048). Running this sequence through the model will result in indexing errors
Token indices sequence length is longer than the specified maximum sequence length for this model (2487 > 2048). Running this sequence through the model will result in indexing errors
Token indices sequence length is longer than the specified maximum sequence length for this model (2487 > 2048). Running this sequence through the model will result in indexing errors
Running epoch: 0: 0it [00:00, ?it/s]Running epoch: 0: 0it [00:00, ?it/s]Running epoch: 0: 0it [00:00, ?it/s]Running epoch: 0: 0it [00:00, ?it/s]`use_cache=True` is incompatible with gradient checkpointing. Setting `use_cache=False`...
`use_cache=True` is incompatible with gradient checkpointing. Setting `use_cache=False`...
`use_cache=True` is incompatible with gradient checkpointing. Setting `use_cache=False`...
`use_cache=True` is incompatible with gradient checkpointing. Setting `use_cache=False`...
Running epoch: 0: 0it [00:20, ?it/s]
Error executing job with overrides: ['typo.beta=0.0', 'wandb.name=typo-lr-1e-6-iteration-1', 'training.checkpoint_dir=/scr/jphilipp/typo/trained_models/Meta-Llama-3-70B/checkpoints-diverse-ultra/typo-1e-6-iteration-1', 'training.lr=1e-6', 'data_path=training_data/base', 'data_file=base_mix_ultra_harmless.json', 'n_examples=5120']
Traceback (most recent call last):
  File "/sailhome/jphilipp/research_projects/typo/experiments/scale/train_llama.py", line 145, in main
    mp.spawn(worker_main, nprocs=world_size, args=(world_size, args, model))
  File "/scr/jphilipp/miniconda3/envs/typo/lib/python3.10/site-packages/torch/multiprocessing/spawn.py", line 246, in spawn
    return start_processes(fn, args, nprocs, join, daemon, start_method="spawn")
  File "/scr/jphilipp/miniconda3/envs/typo/lib/python3.10/site-packages/torch/multiprocessing/spawn.py", line 202, in start_processes
    while not context.join():
  File "/scr/jphilipp/miniconda3/envs/typo/lib/python3.10/site-packages/torch/multiprocessing/spawn.py", line 163, in join
    raise ProcessRaisedException(msg, error_index, failed_process.pid)
torch.multiprocessing.spawn.ProcessRaisedException: 

-- Process 2 terminated with the following error:
Traceback (most recent call last):
  File "/scr/jphilipp/miniconda3/envs/typo/lib/python3.10/site-packages/torch/multiprocessing/spawn.py", line 74, in _wrap
    fn(i, *args)
  File "/sailhome/jphilipp/research_projects/typo/experiments/scale/train_llama.py", line 121, in worker_main
    trainer.train()
  File "/sailhome/jphilipp/research_projects/typo/src/typo/trainers/typo_trainer.py", line 481, in train
    (loss / self.config.training.gradient_accumulation_steps).backward()
  File "/scr/jphilipp/miniconda3/envs/typo/lib/python3.10/site-packages/torch/_tensor.py", line 492, in backward
    torch.autograd.backward(
  File "/scr/jphilipp/miniconda3/envs/typo/lib/python3.10/site-packages/torch/autograd/__init__.py", line 251, in backward
    Variable._execution_engine.run_backward(  # Calls into the C++ engine to run the backward pass
  File "/scr/jphilipp/miniconda3/envs/typo/lib/python3.10/site-packages/torch/autograd/function.py", line 288, in apply
    return user_fn(self, *args)
  File "/scr/jphilipp/miniconda3/envs/typo/lib/python3.10/site-packages/torch/utils/checkpoint.py", line 288, in backward
    torch.autograd.backward(outputs_with_grad, args_with_grad)
  File "/scr/jphilipp/miniconda3/envs/typo/lib/python3.10/site-packages/torch/autograd/__init__.py", line 251, in backward
    Variable._execution_engine.run_backward(  # Calls into the C++ engine to run the backward pass
torch.cuda.OutOfMemoryError: CUDA out of memory. Tried to allocate 1.60 GiB. GPU 2 has a total capacty of 79.15 GiB of which 1.56 GiB is free. Including non-PyTorch memory, this process has 77.58 GiB memory in use. Of the allocated memory 72.53 GiB is allocated by PyTorch, and 3.65 GiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting max_split_size_mb to avoid fragmentation.  See documentation for Memory Management and PYTORCH_CUDA_ALLOC_CONF


Set the environment variable HYDRA_FULL_ERROR=1 for a complete stack trace.
/scr/jphilipp/miniconda3/envs/typo/lib/python3.10/multiprocessing/resource_tracker.py:224: UserWarning: resource_tracker: There appear to be 3 leaked semaphore objects to clean up at shutdown
  warnings.warn('resource_tracker: There appear to be %d '
